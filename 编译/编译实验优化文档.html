
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../index.html">
      
      
        <link rel="next" href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93%E6%84%9F%E6%83%B3.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>编译实验优化文档 - Jew的文档杂项</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../index.html" title="Jew的文档杂项" class="md-header__button md-logo" aria-label="Jew的文档杂项" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jew的文档杂项
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              编译实验优化文档
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
    
  
  Jew的文档杂项

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E4%BC%98%E5%8C%96%E6%96%87%E6%A1%A3.html" class="md-tabs__link">
          
  
    
  
  编译

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Jew的文档杂项" class="md-nav__button md-logo" aria-label="Jew的文档杂项" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Jew的文档杂项
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jew的文档杂项
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    编译
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            编译
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    编译实验优化文档
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E4%BC%98%E5%8C%96%E6%96%87%E6%A1%A3.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    编译实验优化文档
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      中端优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中端优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssa" class="md-nav__link">
    <span class="md-ellipsis">
      SSA：静态单赋值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      删除不可达基本块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mem2reg" class="md-nav__link">
    <span class="md-ellipsis">
      Mem2Reg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      函数副作用分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      函数内联
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      全局变量本地化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="全局变量本地化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      全局常变量优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      全局常数组优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      代码删除
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gvn" class="md-nav__link">
    <span class="md-ellipsis">
      GVN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      常量折叠
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      跳转优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      全局变量访存优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      基本块合并与基本块重排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      输出优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      后端优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="后端优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phi" class="md-nav__link">
    <span class="md-ellipsis">
      消除phi结点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器分配
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      计算强度削弱
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      窥孔优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93%E6%84%9F%E6%83%B3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译实验总结感想
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译实验设计文档
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      中端优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中端优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ssa" class="md-nav__link">
    <span class="md-ellipsis">
      SSA：静态单赋值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      删除不可达基本块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mem2reg" class="md-nav__link">
    <span class="md-ellipsis">
      Mem2Reg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      函数副作用分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      函数内联
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      全局变量本地化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="全局变量本地化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      全局常变量优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      全局常数组优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      代码删除
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gvn" class="md-nav__link">
    <span class="md-ellipsis">
      GVN
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      常量折叠
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      跳转优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      全局变量访存优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      基本块合并与基本块重排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      输出优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      后端优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="后端优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phi" class="md-nav__link">
    <span class="md-ellipsis">
      消除phi结点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器分配
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      计算强度削弱
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      窥孔优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="_1">编译实验优化文档</h1>
<p>代码优化可分为机器无关的中端优化与机器相关的后端优化。以下介绍我的编译器<code>PlatoCompiler</code>实现的优化方法。</p>
<h2 id="_2">中端优化</h2>
<h3 id="ssa">SSA：静态单赋值</h3>
<p>在处理栈或局部变量时，编译器前端通过 alloca 指令将每个局部变量映射到栈上一个对应的空间，将读写映射为对应空间的 load/store 指令。例如以下的指令：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">cond</span><span class="p">;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">cond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getint</span><span class="p">();</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cond</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="k">else</span><span class="p">{</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">}</span>
</code></pre></div>
翻译出来的LLVM IR是：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>define dso_local i32 @main() {
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>b0:
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    %v1 = alloca i32
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    %v2 = alloca i32
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    %v3 = call i32 @getint()
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    store i32 %v3, i32* %v2
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    %v4 = load i32, i32* %v2
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    %v5 = icmp sgt i32 %v4, 0
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    br i1 %v5, label %b6, label %b7
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>b6:
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    store i32 1, i32* %v1
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    br label %b9
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>b7:
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    %v8 = sub i32 0, 1
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    store i32 %v8, i32* %v1
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    br label %b9
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>b9:
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    %v10 = load i32, i32* %v1
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    call void @putint(i32 %v10)
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    ret i32 0
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>}
</code></pre></div>
<p>这种方案简化了前端设计，但是在中间代码上需要进行相关优化时，大量的alloca/load/store指令导致编译器需要跟踪记录变量在栈空间上的位置，这种非SSA形式使得分析def-use关系会变得更加复杂，因此需要消除这些不必要的内存操作。</p>
<p>上述代码的SSA形式为：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>define dso_local i32 @main() {
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>b0:
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    %v1 = call i32 @getint()
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    %v2 = icmp sgt i32 %v1, 0
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    br i1 %v2, label %b3, label %b6
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>b3:
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    br label %b4
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>b4:
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    %v5 = phi i32 [ 1, %b3 ], [ -1, %b6 ]
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    call void @putint(i32 %v5)
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    ret i32 0
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>b6:
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    br label %b4
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>}
</code></pre></div>
<p>为了将非SSA的IR转换为SSA形式，可以采用Mem2Reg的方法。Mem2Reg的核心在于</p>
<ul>
<li>在支配边界（恰好支配不到的基本块）插入phi指令</li>
<li>插入phi后进行重命名</li>
</ul>
<p>为了得到支配边界，我们首先需要构建函数的CFG；构建CFG之前，首先要做的是删除不可达基本块。</p>
<h3 id="_3">删除不可达基本块</h3>
<p>在IR中可能出现以下的语句：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>b10:
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    br label %b8
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    br label %b14
</code></pre></div>
<p>此时<code>br label %14</code>是不可达的语句，需要将终结语句<code>br label %b8</code>之后的代码删除</p>
<p>完成该步骤之后，对每个函数，从第一个基本块开始，根据每个基本块的最后一条语句（一定是终结语句）进行dfs，搜索可能到达的基本块，并删除其他的基本块。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">simplifyFunction</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">func</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">SurplusBlock</span><span class="p">::</span><span class="n">deleteDeadInstr</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="n">dfs</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="na">getEntryBlock</span><span class="p">());</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">removeIf</span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">Instruction</span><span class="p">::</span><span class="n">removeOperands</span><span class="p">);</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">setDeleted</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="p">}</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="n">Instruction</span><span class="w"> </span><span class="n">lastInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getLastInstruction</span><span class="p">();</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastInstruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BrInst</span><span class="w"> </span><span class="n">brInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">isConditional</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">            </span><span class="n">dfs</span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">());</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">            </span><span class="n">dfs</span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">getFalseBlock</span><span class="p">());</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">            </span><span class="n">dfs</span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">());</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="p">}</span>
</code></pre></div>
<h3 id="mem2reg">Mem2Reg</h3>
<p>教程中介绍了对于每个变量v，通过求出$DF^+(Def_v)$就知道了插入phi函数的位置。为了求出DF（支配边界），对于每个函数<code>Function</code>，我们采用以下步骤进行计算：</p>
<ol>
<li>计算CFG图</li>
</ol>
<p>每个基本块都以一个终结语句结尾，与删除不可达基本块类似，通过每一个基本块的终结语句计算该基本块的前驱基本块和后继基本块。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calcControlFlowGraph</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="n">lastInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getLastInstruction</span><span class="p">();</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastInstruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BrInst</span><span class="w"> </span><span class="n">brInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">isConditional</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">                </span><span class="n">addEdge</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">());</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">                </span><span class="n">addEdge</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getFalseBlock</span><span class="p">());</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">                </span><span class="n">addEdge</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">());</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">        </span><span class="n">block</span><span class="p">.</span><span class="na">setNextBlocks</span><span class="p">(</span><span class="n">childBlocks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">block</span><span class="p">));</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="n">block</span><span class="p">.</span><span class="na">setPrevBlocks</span><span class="p">(</span><span class="n">parentBlocks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">block</span><span class="p">));</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="p">}</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addEdge</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="n">childBlocks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">from</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">    </span><span class="n">parentBlocks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p>计算支配树</p>
</li>
<li>
<p>利用定义计算支配关系：在dfs中，如果在遍历时遇到<code>dominator</code>自己，就不再继续递归下去。这相当于在控制流图中“屏蔽”了<code>dominator</code>，测试在没有穿过该块的前提下，能到达哪些块。如果不能访问到基本块<code>block</code>，那么<code>dominator</code>就是<code>block</code>的支配块。</p>
</li>
<li>计算直接支配：如果在<code>dominated</code>被支配的所有块中，有另外一个块<code>otherDominator</code>同时被<code>dominator</code>支配，则<code>dominator</code>可能并不是距离<code>dominated</code>最近的支配者，因为<code>otherDominator</code>夹在中间。A支配C且A支配B，C支配B时，则A不是B的直接支配，而C才是。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calcDominatorTree</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominator</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reachableBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="n">dfs</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">dominator</span><span class="p">,</span><span class="w"> </span><span class="n">reachableBlocks</span><span class="p">);</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reachableBlocks</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">                </span><span class="n">dominates</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominator</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">                </span><span class="n">dominatedBy</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">block</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">dominator</span><span class="p">);</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="n">dominator</span><span class="p">.</span><span class="na">setDominateBlocks</span><span class="p">(</span><span class="n">dominates</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominator</span><span class="p">));</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominated</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominator</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dominatedBy</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominated</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isImmediateDominator</span><span class="p">(</span><span class="n">dominator</span><span class="p">,</span><span class="w"> </span><span class="n">dominated</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">                </span><span class="n">dominated</span><span class="p">.</span><span class="na">setImmediateDominator</span><span class="p">(</span><span class="n">dominator</span><span class="p">);</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">                </span><span class="n">immediatelyDominates</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominator</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">dominated</span><span class="p">);</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">        </span><span class="n">block</span><span class="p">.</span><span class="na">setImmediateDominateBlocks</span><span class="p">(</span><span class="n">immediatelyDominates</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">block</span><span class="p">));</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="p">}</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominator</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reachableBlocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="n">reachableBlocks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">dominator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reachableBlocks</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">            </span><span class="n">dfs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">dominator</span><span class="p">,</span><span class="w"> </span><span class="n">reachableBlocks</span><span class="p">);</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="p">}</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isImmediateDominator</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominator</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">otherDominator</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dominatedBy</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominated</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">otherDominator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dominator</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dominates</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">dominator</span><span class="p">).</span><span class="na">contains</span><span class="p">(</span><span class="n">otherDominator</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>以上算法的时间复杂度较高，可考虑Lengauer-Tarjan算法来优化效率</p>
</blockquote>
<ol>
<li>计算支配边界</li>
</ol>
<p>对于每一个被<code>dominator</code>支配的块<code>dominated</code>，查看它的直接后继块<code>child</code>。如果这个<code>child</code>不在<code>dominator</code>支配的集合中，说明该<code>child</code>位于<code>dominator</code>所支配区域之外。由于<code>child</code>直接跟<code>dominated</code>相连，而<code>dominated</code>受<code>dominator</code>支配，但是<code>child</code>不受<code>dominator</code>支配，那么<code>child</code>就是支配边界中的一员（形成了支配区域与非支配区域之间的边界）。</p>
<p>如果<code>dominator</code>的直接后继也不受<code>dominator</code>支配，那么该后继块也可视为支配边界的一部分。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calcDominanceFrontier</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominator</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">currentFunction</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">frontier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominated</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dominator</span><span class="p">.</span><span class="na">getDominateBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dominated</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dominator</span><span class="p">.</span><span class="na">getDominateBlocks</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">                        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">frontier</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">                    </span><span class="n">frontier</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dominator</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dominator</span><span class="p">.</span><span class="na">getDominateBlocks</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">frontier</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">                </span><span class="n">frontier</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">        </span><span class="n">dominator</span><span class="p">.</span><span class="na">setDominanceFrontier</span><span class="p">(</span><span class="n">frontier</span><span class="p">);</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>计算def集合和use集合</li>
</ol>
<p>对于<code>Function</code>中的每一个alloca指令（不考虑数组），通过<code>User-Use-Value</code>关系，对其所有的使用者进行分类。<code>useInstructions</code>存放所有对该变量的读取（<code>load</code>）指令。<code>defInstructions</code>存放所有对该变量的定义（<code>store</code>）指令。<code>defBlocks</code>记录所有存在该变量定义（<code>store</code>）的基本块。</p>
<ol>
<li>插入phi</li>
</ol>
<p>按照伪代码进行操作即可。</p>
<p><img alt="1.png" src="https://drinkwater-1325041233.cos.ap-guangzhou.myqcloud.com/imgs/wvPf9pKkCDtAZy3.png" /></p>
<p>一种可能的实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">insertPhi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">defBlocks</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">W</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">W</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">X</span><span class="p">.</span><span class="na">getDominanceFrontier</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">F</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">                </span><span class="n">PhiInst</span><span class="w"> </span><span class="n">phiInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PhiInst</span><span class="p">(</span><span class="n">currentAlloc</span><span class="p">.</span><span class="na">getTargetType</span><span class="p">(),</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">                        </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Y</span><span class="p">.</span><span class="na">getPrevBlocks</span><span class="p">()));</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">                </span><span class="n">Y</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">phiInst</span><span class="p">);</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">                </span><span class="n">useInstructions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">phiInst</span><span class="p">);</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">                </span><span class="n">defInstructions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">phiInst</span><span class="p">);</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">                </span><span class="n">F</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Y</span><span class="p">);</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">defBlocks</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">                    </span><span class="n">W</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Y</span><span class="p">);</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>变量重命名</li>
</ol>
<p>参考教程提供的伪代码，通过遍历支配树来进行，给每个单独的存活区间一个新的变量名。</p>
<ul>
<li>当遇到store时，将store的值压入栈（defStack），表示变量在此处有了一个新版本</li>
<li>当遇到load时，用栈顶的值替换load指令（即用当前最新版本的变量值），从而消除对内存的读取</li>
<li>当遇到phi时，也将phi节点作为新定义压入栈中，以便后续使用</li>
<li>对所有后继基本块的phi指令设置来自当前块的值，如果defStack为空，设置为Undefined。这种情况为UB，在我的编译器中是设为0。</li>
<li>当离开该基本块时，将在该块中所推入的定义值从栈中弹出，以保持栈的正确性</li>
<li>删除已被处理的alloca/load/store指令</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">renameVariables</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pushCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">currentAlloc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">            </span><span class="n">it</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LoadInst</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">useInstructions</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defStack</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Undefined</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">defStack</span><span class="p">.</span><span class="na">peek</span><span class="p">();</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">            </span><span class="n">instruction</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">);</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">            </span><span class="n">it</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">StoreInst</span><span class="w"> </span><span class="n">storeInst</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">defInstructions</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">            </span><span class="n">defStack</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">storeInst</span><span class="p">.</span><span class="na">getStoredValue</span><span class="p">());</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">            </span><span class="n">instruction</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">            </span><span class="n">pushCount</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">            </span><span class="n">it</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">PhiInst</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">defInstructions</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">            </span><span class="n">pushCount</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">            </span><span class="n">defStack</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">instruction</span><span class="p">);</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="n">firstInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getFirstInstruction</span><span class="p">();</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstInstruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">PhiInst</span><span class="w"> </span><span class="n">phiInst</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">useInstructions</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">firstInstruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defStack</span><span class="p">.</span><span class="na">empty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Undefined</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">defStack</span><span class="p">.</span><span class="na">peek</span><span class="p">();</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">            </span><span class="n">phiInst</span><span class="p">.</span><span class="na">addValue</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">dominated</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getImmediateDominateBlocks</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">        </span><span class="n">renameVariables</span><span class="p">(</span><span class="n">dominated</span><span class="p">);</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pushCount</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">        </span><span class="n">defStack</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_4">函数副作用分析</h3>
<p>对所有函数进行分析，没有副作用的函数（pure function）可以进行更多的优化。</p>
<p>判断一个函数有副作用的判定标准为：</p>
<ol>
<li>存在IO相关指令：IO会对外部状态产生影响</li>
<li>写全局变量：改变Module的全局状态</li>
<li>写通过<code>FuncParam</code>或<code>GlobalVar</code>间接引用的内存：通过参数或全局引用（如数组指针）对外部可见状态进行了修改</li>
<li>调用有副作用的函数</li>
</ol>
<p>在代码实现上，第一遍扫描后，可能有一些函数调用了有副作用的函数，但是自身状态没有更新，此时需要对函数的调用关系进行传递。</p>
<h3 id="_5">函数内联</h3>
<p>函数内联通过被调用的函数体直接“复制”到调用处，从而消除函数调用的开销，同时为后续优化创造机会。</p>
<ol>
<li>构建调用图</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeCallGraphs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="n">callGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">reverseCallGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">module</span><span class="p">.</span><span class="na">getFunctions</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">callGraph</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="n">reverseCallGraph</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="n">module</span><span class="p">.</span><span class="na">getFunctions</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="n">func</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">                    </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">                    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">CallInst</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">                    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">CallInst</span><span class="p">)</span><span class="w"> </span><span class="n">instr</span><span class="p">)</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">                    </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">callInst</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">                        </span><span class="n">Function</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">callInst</span><span class="p">.</span><span class="na">getCalledFunction</span><span class="p">();</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">                        </span><span class="n">callGraph</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">func</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">                        </span><span class="n">reverseCallGraph</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="na">add</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">                    </span><span class="p">})</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p>判断是否需要内联，需要满足</p>
</li>
<li>
<p>不是main函数</p>
</li>
<li>函数被调用，且函数不调用其他函数（叶子函数）</li>
<li>不存在递归</li>
</ol>
<p>如果上述条件都满足，则找出所有对该function的调用点。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CallInst</span><span class="o">&gt;</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reverseCallGraph</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">function</span><span class="p">).</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">caller</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">caller</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">            </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">CallInst</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">CallInst</span><span class="p">)</span><span class="w"> </span><span class="n">instr</span><span class="p">)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">            </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">callInst</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">callInst</span><span class="p">.</span><span class="na">getOperands</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">function</span><span class="p">.</span><span class="na">getName</span><span class="p">()))</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toCollection</span><span class="p">(</span><span class="n">ArrayList</span><span class="p">::</span><span class="k">new</span><span class="p">));</span>
</code></pre></div>
<ol>
<li>分裂基本块：在调用指令所在的基本块之后新建一个基本块nextBlock，将call指令之后的指令移动到nextBlock，并删除call指令。这样做的原因是为了方便在插入被调函数的代码后，可以无缝衔接原来的控制流。</li>
</ol>
<p>分裂基本块后需要更新phi指令的前趋基本块信息。</p>
<ol>
<li>
<p>对被调用的函数代码进行深拷贝得到<code>copiedFunction</code>，将被调用函数的形式参数用调用指令的实参替换，在原来call指令的位置插入无条件跳转指令，跳转至<code>copiedFunction</code>的入口基本块，将<code>copiedFunction</code>的基本块插入。</p>
</li>
<li>
<p>处理<code>copiedFunction</code>的<code>RetInst</code>：</p>
</li>
<li>
<p>如果返回类型是<code>void</code>，将返回点转化为无条件跳转到nextBlock；</p>
</li>
<li>
<p>如果有非void返回值，在nextBlock开头插入phi结点，用原本<code>RetInst</code>的返回值作为phi的操作数。</p>
</li>
<li>
<p>每次会根据当前的调用图重新判断是否有新的函数可以内联。一旦有函数被内联修改了模块，则可能解开更多内联机会。</p>
</li>
</ol>
<p>再次循环，直到没有更多可内联的函数。</p>
<h3 id="_6">全局变量本地化</h3>
<p>全局变量本地化的目的是将全局变量转换为更局部的形式（如函数内的局部变量），优化对全局变量的存取操作，同时暴露更多的优化机会。</p>
<ol>
<li>检查全局变量的使用情况</li>
</ol>
<p>在<code>PlatoCompiler</code>中，一个<code>Module</code>由多个<code>Function</code>和多个<code>GlobalVar</code>组成。对于每个<code>GlobalVar</code>，检查其在哪些函数中被使用。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkUse</span><span class="p">(</span><span class="n">Module</span><span class="w"> </span><span class="n">module</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">GlobalVar</span><span class="w"> </span><span class="n">gv</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="na">getGlobalVars</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getUserList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">            </span><span class="n">Function</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">Instruction</span><span class="p">)</span><span class="w"> </span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">                    </span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">().</span><span class="na">getFunction</span><span class="p">();</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">            </span><span class="n">usedMap</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">gv</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p>构建函数调用图</p>
</li>
<li>
<p>采取保守的策略，将满足以下条件的全局变量进行本地化处理：</p>
</li>
<li>
<p>类型为<code>i8</code>或<code>i32</code></p>
</li>
<li>只在某一个函数<code>func</code>中被使用，且<code>func</code>没有被其他函数调用</li>
</ol>
<p>本地化的操作步骤为：</p>
<ol>
<li>
<p>根据全局变量类型创建alloca语句，插入入口基本块</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">BasicBlock</span><span class="w"> </span><span class="n">entryBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="na">getEntryBlock</span><span class="p">();</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">ValueType</span><span class="w"> </span><span class="n">gvType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">PointerType</span><span class="p">)</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getValueType</span><span class="p">()).</span><span class="na">getTargetType</span><span class="p">();</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">AllocInst</span><span class="w"> </span><span class="n">allocInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AllocInst</span><span class="p">(</span><span class="n">gvType</span><span class="p">);</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">allocInst</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">entryBlock</span><span class="p">);</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">entryBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">allocInst</span><span class="p">);</span>
</code></pre></div>
</li>
<li>
<p>插入store语句，根据初始值设置新变量的初始值，缺省为0</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">initValue</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">VarSymbol</span><span class="w"> </span><span class="n">varSymbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VarSymbol</span><span class="p">)</span><span class="w"> </span><span class="n">TableManager</span><span class="p">.</span><span class="na">getInstance1</span><span class="p">()</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">        </span><span class="p">.</span><span class="na">getSymbol</span><span class="p">(</span><span class="n">gv</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">InitialValue</span><span class="w"> </span><span class="n">initialValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getInitialValue</span><span class="p">();</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initialValue</span><span class="p">.</span><span class="na">getElements</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="n">initValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="n">initValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getConstValue</span><span class="p">();</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">}</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="n">StoreInst</span><span class="w"> </span><span class="n">storeInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StoreInst</span><span class="p">(</span><span class="n">allocInst</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">gvType</span><span class="p">,</span><span class="w"> </span><span class="n">initValue</span><span class="p">));</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="n">storeInst</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">entryBlock</span><span class="p">);</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="n">entryBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">storeInst</span><span class="p">);</span>
</code></pre></div>
</li>
<li>
<p>将对全局变量的所有使用替换为新分配的局部变量，移除该全局变量</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">gv</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">allocInst</span><span class="p">);</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">toRemove</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">gv</span><span class="p">);</span>
</code></pre></div>
</li>
</ol>
<p>以上对一般的全局变量本地化替换策略较为保守，是因为在某些情况下，过于激进的优化会导致全局变量在其他函数中的使用仍然存在，使得部分函数依赖于该全局变量而另一些函数则不再使用，从而导致程序的语义发生改变。但是假设该全局变量满足一些特殊条件，那么可以采取另外的优化方法</p>
<h4 id="_7">全局常变量优化</h4>
<p>对于定义在全局的常变量<code>const int a = 4</code>，其值不会再发生改变，于是可将所有使用到全局常变量的load指令替换为一个常数，例如所有的<code>%v2 = load i32, i32* @a</code>，我们可以直接得到<code>%v2</code>的值是4。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">// gv的valuetype默认是指针类型</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">ValueType</span><span class="w"> </span><span class="n">gvType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">PointerType</span><span class="p">)</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getValueType</span><span class="p">()).</span><span class="na">getTargetType</span><span class="p">();</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gvType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">gvType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">initValue</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="n">InitialValue</span><span class="w"> </span><span class="n">initialValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getInitialValue</span><span class="p">();</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initialValue</span><span class="p">.</span><span class="na">getElements</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="n">initValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="n">initValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getConstValue</span><span class="p">();</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">gvType</span><span class="p">,</span><span class="w"> </span><span class="n">initValue</span><span class="p">);</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getUserList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LoadInst</span><span class="w"> </span><span class="n">loadInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">            </span><span class="n">loadInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">constInt</span><span class="p">);</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">            </span><span class="n">toRemove</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">gv</span><span class="p">);</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">            </span><span class="n">loadInst</span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">().</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">loadInst</span><span class="p">);</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="p">}</span>
</code></pre></div>
<h4 id="_8">全局常数组优化</h4>
<p>对常数组<code>const int a[3] = {1, 2, 3}</code>，与常变量类似，可以将常数下标数组访问替换为具体值，如<code>int b = a[2]</code>可以直接替换为<code>int b = 3</code>。</p>
<p>需要注意考虑下标非常数的情况，比如<code>int c = a[b]</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">ValueType</span><span class="w"> </span><span class="n">gvType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">PointerType</span><span class="p">)</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getValueType</span><span class="p">()).</span><span class="na">getTargetType</span><span class="p">();</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gvType</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ArrayType</span><span class="w"> </span><span class="n">arrayType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">}</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="n">gvType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrayType</span><span class="p">.</span><span class="na">getElementType</span><span class="p">();</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gvType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">gvType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">gv</span><span class="p">.</span><span class="na">getUserList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GepInst</span><span class="w"> </span><span class="n">gepInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gepInst</span><span class="p">.</span><span class="na">getIndex</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">();</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">gepInst</span><span class="p">.</span><span class="na">getUserList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user1</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LoadInst</span><span class="w"> </span><span class="n">loadInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">intValue</span><span class="p">;</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getInitialValue</span><span class="p">().</span><span class="na">getElements</span><span class="p">().</span><span class="na">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">                            </span><span class="n">intValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varSymbol</span><span class="p">.</span><span class="na">getConstValue</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">                            </span><span class="n">intValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">                        </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">gvType</span><span class="p">,</span><span class="w"> </span><span class="n">intValue</span><span class="p">);</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">                        </span><span class="n">loadInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">constInt1</span><span class="p">);</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">                        </span><span class="n">loadInst</span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">().</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">loadInst</span><span class="p">);</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="p">}</span>
</code></pre></div>
<p>以上对于全局常数组的优化同样适用于局部常数组，方法类似，在此不再赘述。</p>
<h3 id="_9">代码删除</h3>
<p>代码删除通过遍历有用函数中的每条指令，并沿着def-use链构建有用指令的<strong>闭包</strong>，删除不在闭包的指令。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">usefulInstructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findUseful</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="n">removeUseless</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">usefulInstructions</span><span class="p">);</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="p">}</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="c1">// 查找有用的指令</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findUseful</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">useful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="n">function</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">                    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">CodeRemoval</span><span class="p">::</span><span class="n">isUseful</span><span class="p">)</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">                    </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">getClosure</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">useful</span><span class="p">))</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">useful</span><span class="p">;</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="p">}</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="c1">// 获取所有依赖关系的闭包</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getClosure</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">useful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="n">Stack</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stack</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="n">stack</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">instruction</span><span class="p">);</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stack</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="n">curInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">useful</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">curInstruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">            </span><span class="n">curInstruction</span><span class="p">.</span><span class="na">getOperands</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">                    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">operand</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">operand</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Instruction</span><span class="p">)</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">                    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">operand</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="p">)</span><span class="w"> </span><span class="n">operand</span><span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">                    </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">stack</span><span class="p">::</span><span class="n">push</span><span class="p">);</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="p">}</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isUseful</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="w">    </span><span class="c1">// 判断指令是否有用</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="p">}</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="c1">// 移除无用的指令</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeUseless</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">useful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="w">    </span><span class="n">function</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">removeIf</span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">useful</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">instruction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="w">                    </span><span class="n">instruction</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="w">            </span><span class="p">})</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="p">}</span>
</code></pre></div>
<p>除此之外，该阶段还可以完成<strong>无用函数删除、无用数组删除</strong>等工作。</p>
<h3 id="gvn">GVN</h3>
<p>GVN通过为每个唯一的计算分配一个值编号，确保相同计算只执行一次，并重用其结果。这样的“值编号”分配可以使用指令的哈希值进行。</p>
<ol>
<li>对每条指令生成唯一的哈希值：在LLVM IR中，可对计算语句、指针计算语句、函数调用语句、截断与扩展语句进行处理。</li>
</ol>
<p>由于计算语句存在左右两个变量，对于满足交换律的加法和乘法，对左右变量顺序进行调整，使得<code>a + b</code>和<code>b + a</code>可被识别为公共表达式；对于<code>icmp</code>逻辑计算语句，也可以通过类似的方法，将<code>b &gt; a</code>转化为<code>a &lt; b</code>。</p>
<p>对于可处理的<code>call</code>语句，需要额外判断所调用的函数是否有潜在副作用。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getHash</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">lName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand1</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">rName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand2</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OperatorType</span><span class="p">.</span><span class="na">isLogicalOperator</span><span class="p">(</span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">ADD</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">                    </span><span class="o">||</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">MUL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lName</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">rName</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">rName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lName</span><span class="p">;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">lName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rName</span><span class="p">;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">            </span><span class="n">OperatorType</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">();</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lName</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">rName</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">                </span><span class="n">lName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand2</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">                </span><span class="n">rName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand1</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">                </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SGE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">ICMP_SLE</span><span class="p">;</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SGT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">ICMP_SLT</span><span class="p">;</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SLT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">ICMP_SGT</span><span class="p">;</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SLE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">ICMP_SGE</span><span class="p">;</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">                    </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="w">                </span><span class="p">};</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">lName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rName</span><span class="p">;</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GepInst</span><span class="w"> </span><span class="n">gepInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">gepInst</span><span class="p">.</span><span class="na">getPointer</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">gepInst</span><span class="p">.</span><span class="na">getIndex</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="n">callInst</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">callCanReplaced</span><span class="p">(</span><span class="n">callInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">callInst</span><span class="p">.</span><span class="na">getCallee</span><span class="p">();</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">TruncInst</span><span class="w"> </span><span class="n">truncInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">truncInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; trunc &quot;</span>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">truncInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">().</span><span class="na">getValueType</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">truncInst</span><span class="p">.</span><span class="na">getValueType</span><span class="p">();</span>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ZextInst</span><span class="w"> </span><span class="n">zextInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zextInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">().</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; zext &quot;</span>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">zextInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">().</span><span class="na">getValueType</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; -&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zextInst</span><span class="p">.</span><span class="na">getValueType</span><span class="p">();</span>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>如果哈希值已存在，说明当前指令是冗余的，可以用已有的值替换，并移除该指令。</li>
</ol>
<p>当前基本块处理完成后，递归处理支配树中的子基本块，确保全局范围内的等价指令都能被识别。在退出当前基本块后，移除在该基本块中插入的哈希值，避免影响其他独立的控制流路径。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">visitBlock</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">());</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="n">instructions</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">gvnHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHash</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gvnHash</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gvnMap</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">gvnHash</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">                </span><span class="n">instr</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">gvnMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">gvnHash</span><span class="p">));</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">                </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">                </span><span class="n">instr</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">                </span><span class="n">gvnMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">gvnHash</span><span class="p">,</span><span class="w"> </span><span class="n">instr</span><span class="p">);</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">                </span><span class="n">inserted</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">gvnHash</span><span class="p">);</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">    </span><span class="n">block</span><span class="p">.</span><span class="na">getImmediateDominateBlocks</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">GVN</span><span class="p">::</span><span class="n">visitBlock</span><span class="p">);</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">    </span><span class="n">inserted</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">gvnMap</span><span class="p">::</span><span class="n">remove</span><span class="p">);</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_10">常量折叠</h3>
<p>常量折叠可进行的优化较多。</p>
<ol>
<li>对于截断与扩展指令，如果操作数是常量，则可以直接将值替换为对应位数的值。</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">zextOptimize</span><span class="p">(</span><span class="n">ZextInst</span><span class="w"> </span><span class="n">zextInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zextInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">();</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">origin</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">();</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="n">ValueType</span><span class="w"> </span><span class="n">targetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zextInst</span><span class="p">.</span><span class="na">getValueType</span><span class="p">();</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">targetType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">            </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">targetType</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">            </span><span class="n">zextInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">constInt1</span><span class="p">);</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">            </span><span class="n">zextInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">            </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">zextInst</span><span class="p">);</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="p">}</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">truncOptimize</span><span class="p">(</span><span class="n">TruncInst</span><span class="w"> </span><span class="n">truncInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">truncInst</span><span class="p">.</span><span class="na">getOriginValue</span><span class="p">();</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">origin</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">();</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">        </span><span class="n">ValueType</span><span class="w"> </span><span class="n">targetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">truncInst</span><span class="p">.</span><span class="na">getValueType</span><span class="p">();</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targetType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">constInt</span><span class="p">.</span><span class="na">getValueType</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i32</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">            </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">targetType</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">);</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">            </span><span class="n">truncInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">constInt1</span><span class="p">);</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">            </span><span class="n">truncInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">            </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">truncInst</span><span class="p">);</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li><code>a % b = a - a / b * b（b为常数）</code>，方便后端进行乘除优化</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">srem2div</span><span class="p">(</span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">inst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="na">getOperand1</span><span class="p">();</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="na">getOperand2</span><span class="p">();</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">curBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">();</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">        </span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinaryInst</span><span class="p">(</span><span class="n">OperatorType</span><span class="p">.</span><span class="na">SDIV</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">        </span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">mul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinaryInst</span><span class="p">(</span><span class="n">OperatorType</span><span class="p">.</span><span class="na">MUL</span><span class="p">,</span><span class="w"> </span><span class="n">div</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">        </span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BinaryInst</span><span class="p">(</span><span class="n">OperatorType</span><span class="p">.</span><span class="na">SUB</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">mul</span><span class="p">);</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">        </span><span class="n">div</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">curBlock</span><span class="p">);</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">        </span><span class="n">mul</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">curBlock</span><span class="p">);</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">        </span><span class="n">sub</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">curBlock</span><span class="p">);</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">inst</span><span class="p">),</span><span class="w"> </span><span class="n">div</span><span class="p">);</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">div</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mul</span><span class="p">);</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">mul</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sub</span><span class="p">);</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">sub</span><span class="p">);</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">        </span><span class="n">inst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p>对计算语句<code>BinaryInst</code>，分别讨论两个操作数中常数的数量，进行对应的优化</p>
</li>
<li>
<p>两个操作数均为常数，则可以立即计算结果并代替原指令</p>
</li>
<li>其中一个操作数为常数<ul>
<li>a + 0 = 0 + a = a</li>
<li>a - 0 = a</li>
<li>a * 0 = 0 * a = 0</li>
<li>a * 1 = 1 * a = a</li>
<li>0 / a = 0</li>
<li>a / 1 = 1</li>
<li>o % a = 0</li>
<li>a % 1 = a % (-1) = 0</li>
</ul>
</li>
<li>
<p>两个操作数均非常数</p>
<ul>
<li>(a - b) + b = b + (a - b) = a</li>
<li>(a + b) + (a - b) = 2a</li>
<li>a - a = 0</li>
<li>(a + b) - b = a, (a + b) - a = b</li>
<li>a - (a - b) = b</li>
<li>a / a = 1</li>
<li>a % a = 0</li>
</ul>
</li>
<li>
<p>完成后对phi节点进行优化：</p>
</li>
<li>
<p>清理Phi指令中来自已删除基本块的操作数和对应的基本块；</p>
</li>
<li>如果Phi指令的所有操作数相同，或者Phi指令没有用户，则将Phi指令替换为其中一个操作数，简化Phi指令；</li>
<li>移除Phi指令中来自已删除基本块的操作数和对应的基本块</li>
</ol>
<h3 id="_11">跳转优化</h3>
<p>与常量折叠类似，对于一些<code>icmp</code>指令，也可提前计算出结果，如<code>%cmp1 = icmp eq i32 5, 5</code>可被替换为<code>%cmp1 = 1</code>。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">icmpOptimize</span><span class="p">(</span><span class="n">BinaryInst</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand1</span><span class="p">();</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">value2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOperand2</span><span class="p">();</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value1</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value2</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">        </span><span class="n">OperatorType</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getOpType</span><span class="p">();</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt1</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">();</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt2</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">();</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_EQ</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_NE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SGE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SGT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SLE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">ICMP_SLT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cons2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">            </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">        </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstInt</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">.</span><span class="na">i1</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">curBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">();</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">binaryInst</span><span class="p">);</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">        </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">constInt</span><span class="p">);</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">        </span><span class="n">binaryInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="p">}</span>
</code></pre></div>
<p>此时一些<code>br</code>的跳转方向已经确定，此时可以通过将有条件br改写成无条件br，例如<code>br i1 1, label %true, label %false</code>可被替换为<code>br label %true</code>。</p>
<p>跳转优化不仅能减少代码体积，同时通过删除无用代码与修改CFG，暴露潜在的优化机会。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">brOptimize</span><span class="p">(</span><span class="n">BrInst</span><span class="w"> </span><span class="n">brInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getCondition</span><span class="p">();</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">curBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getBasicBlock</span><span class="p">();</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ConstInt</span><span class="w"> </span><span class="n">constInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="n">BrInst</span><span class="w"> </span><span class="n">noCondBr</span><span class="p">;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">targetBlock</span><span class="p">;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="p">.</span><span class="na">getIntValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">            </span><span class="n">targetBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getFalseBlock</span><span class="p">();</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">            </span><span class="n">curBlock</span><span class="p">.</span><span class="na">deleteForPhi</span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">());</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">            </span><span class="n">targetBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brInst</span><span class="p">.</span><span class="na">getTrueBlock</span><span class="p">();</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">            </span><span class="n">curBlock</span><span class="p">.</span><span class="na">deleteForPhi</span><span class="p">(</span><span class="n">brInst</span><span class="p">.</span><span class="na">getFalseBlock</span><span class="p">());</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">        </span><span class="n">noCondBr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BrInst</span><span class="p">(</span><span class="n">targetBlock</span><span class="p">);</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">        </span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">curBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">brInst</span><span class="p">),</span><span class="w"> </span><span class="n">noCondBr</span><span class="p">);</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="w">        </span><span class="n">brInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="p">}</span>
</code></pre></div>
<p>最后同样对phi指令进行处理，同时删除掉不可达的基本块。</p>
<h3 id="_12">全局变量访存优化</h3>
<p>对于全局变量可通过跟踪load和store进行优化。</p>
<ul>
<li>store指令：</li>
<li>跟踪对全局变量的存储操作，记录最新的存储值。</li>
<li>
<p>如果全局变量的存储值已经被记录且没有被修改，可以移除冗余的store指令。</p>
</li>
<li>
<p>load指令：</p>
</li>
<li>
<p>如果加载操作指向的全局变量已经有最新的存储值，可以将load指令替换为存储的常量值，消除不必要的内存读取。</p>
</li>
<li>
<p>处理函数调用：</p>
</li>
<li>函数调用可能会修改全局变量的状态，因此在遇到call指令时，需要清除当前的存储映射，确保后续优化的正确性。</li>
<li>在函数调用之前，重新插入所有记录的store指令，以维护全局变量的状态一致性。</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">optimizeGlobalVar</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">basicBlock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">GlobalVar</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gvMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">GlobalVar</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">writeMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">());</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="c1">// 如果是全局数组，那么getPointer得到的应该是gepInst</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="c1">// 因此以下的操作针对的是全局变量，而非全局数组</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">instructions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">StoreInst</span><span class="w"> </span><span class="n">storeInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">storeInst</span><span class="p">.</span><span class="na">getPointer</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GlobalVar</span><span class="w"> </span><span class="n">globalVar</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">            </span><span class="n">gvMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">globalVar</span><span class="p">,</span><span class="w"> </span><span class="n">storeInst</span><span class="p">.</span><span class="na">getStoredValue</span><span class="p">());</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">            </span><span class="n">writeMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">globalVar</span><span class="p">,</span><span class="w"> </span><span class="n">storeInst</span><span class="p">.</span><span class="na">getStoredValue</span><span class="p">());</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">            </span><span class="n">storeInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">            </span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">instruction</span><span class="p">);</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">LoadInst</span><span class="w"> </span><span class="n">loadInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">loadInst</span><span class="p">.</span><span class="na">getPointer</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GlobalVar</span><span class="w"> </span><span class="n">globalVar</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gvMap</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">globalVar</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">                </span><span class="n">loadInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">gvMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">globalVar</span><span class="p">));</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">                </span><span class="n">loadInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">                </span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">instruction</span><span class="p">);</span>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">                </span><span class="n">gvMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">globalVar</span><span class="p">,</span><span class="w"> </span><span class="n">loadInst</span><span class="p">);</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">CallInst</span><span class="w"> </span><span class="n">callInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">            </span><span class="n">gvMap</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">GlobalVar</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">writeMap</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">                </span><span class="n">StoreInst</span><span class="w"> </span><span class="n">storeInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StoreInst</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">                </span><span class="n">storeInst</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">);</span>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">                </span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">callInst</span><span class="p">),</span><span class="w"> </span><span class="n">storeInst</span><span class="p">);</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="w">            </span><span class="n">writeMap</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">GlobalVar</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">writeMap</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="w">        </span><span class="n">StoreInst</span><span class="w"> </span><span class="n">storeInst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StoreInst</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="w">        </span><span class="n">storeInst</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">);</span>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a><span class="w">        </span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">storeInst</span><span class="p">);</span>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_13">基本块合并与基本块重排</h3>
<p>合并基本块并对基本块进行排序，可以降低跳转指令的执行次数。</p>
<p>如果<code>block</code>有且仅有一个后继基本块<code>child</code>，并且<code>child</code>的前驱基本块数量也是1（即只有<code>block</code>一个前驱），且未被删除，则可以尝试合并。合并之后需要对涉及到的br语句与phi结点进行修改。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">function</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">());</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="c1">// 使用迭代器安全地在遍历时移除块</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blocks</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="na">isDeleted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">().</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">            </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="na">getNextBlocks</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="na">getPrevBlocks</span><span class="p">().</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">child</span><span class="p">.</span><span class="na">isDeleted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">                </span><span class="c1">// 合并块和子块</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">                </span><span class="n">performMerge</span><span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">                </span><span class="n">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">    </span><span class="c1">// 如果进行了合并，更新函数的基本块列表</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">merged</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">        </span><span class="c1">// 过滤掉已删除的块</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updatedBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">.</span><span class="na">isDeleted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">                </span><span class="n">updatedBlocks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">        </span><span class="n">function</span><span class="p">.</span><span class="na">setBasicBlocks</span><span class="p">(</span><span class="n">updatedBlocks</span><span class="p">);</span>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">merged</span><span class="p">;</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="p">}</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">performMerge</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">    </span><span class="c1">// 从父块中移除跳转指令</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">    </span><span class="n">Instruction</span><span class="w"> </span><span class="n">jumpInstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">getLastInstruction</span><span class="p">();</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">    </span><span class="n">jumpInstr</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">    </span><span class="n">parent</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">remove</span><span class="p">(</span><span class="n">jumpInstr</span><span class="p">);</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">    </span><span class="c1">// 将子块中的所有指令移动到父块</span>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">    </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">iterator</span><span class="p">();</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">        </span><span class="n">Instruction</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instr</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">PhiInst</span><span class="w"> </span><span class="n">phiInst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">            </span><span class="c1">// 更新 phi 指令以使用来自父块的操作数</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phiInst</span><span class="p">.</span><span class="na">getBlocks</span><span class="p">().</span><span class="na">indexOf</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a><span class="w">                </span><span class="n">Value</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phiInst</span><span class="p">.</span><span class="na">getOperands</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="w">                </span><span class="n">phiInst</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">newValue</span><span class="p">);</span>
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a><span class="w">            </span><span class="n">phiInst</span><span class="p">.</span><span class="na">removeOperands</span><span class="p">();</span>
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a><span class="w">            </span><span class="n">parent</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a><span class="w">            </span><span class="n">instr</span><span class="p">.</span><span class="na">setBasicBlock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a><span class="w">        </span><span class="n">it</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
<a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a>
<a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a><span class="w">    </span><span class="c1">// 将子块的引用重定向到父块，并标记子块为已删除</span>
<a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a><span class="w">    </span><span class="n">child</span><span class="p">.</span><span class="na">replaceByNewValue</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a><span class="w">    </span><span class="n">child</span><span class="p">.</span><span class="na">setDeleted</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a><span class="p">}</span>
</code></pre></div>
<p>对已有的基本块，可以采用dfs的方法进行排序，使得控制流路径上的基本块尽可能连续排列，提升指令缓存的命中率，提高执行效率。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">reorderBasicBlocksDFS</span><span class="p">(</span><span class="n">Function</span><span class="w"> </span><span class="n">function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">.</span><span class="na">getBasicBlocks</span><span class="p">();</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orderedBlocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="n">Deque</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blocks</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">        </span><span class="n">stack</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">blocks</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stack</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">        </span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">current</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">            </span><span class="n">visited</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">            </span><span class="n">orderedBlocks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">            </span><span class="c1">// 逆序压栈以保持顺序</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">BasicBlock</span><span class="o">&gt;</span><span class="w"> </span><span class="n">successors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSuccessors</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w">            </span><span class="n">Collections</span><span class="p">.</span><span class="na">reverse</span><span class="p">(</span><span class="n">successors</span><span class="p">);</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">succ</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">successors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">succ</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w">                    </span><span class="n">stack</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">succ</span><span class="p">);</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w">    </span><span class="c1">// 将未在DFS中访问到的块追加到末尾</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">visited</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">block</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w">            </span><span class="n">orderedBlocks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">orderedBlocks</span><span class="p">;</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_14">输出优化</h3>
<p>对于连续输出的常数/常字符串，可以通过连续拼接整合输出。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="n">BasicBlock</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">changed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">        </span><span class="n">changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">        </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">());</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">instructions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">            </span><span class="n">Instruction</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instructions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">instruction</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">OutputInst</span><span class="w"> </span><span class="n">outputInst</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">outputInst</span><span class="p">.</span><span class="na">constContent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">            </span><span class="n">buffer</span><span class="p">.</span><span class="na">add</span><span class="p">((</span><span class="n">Instruction</span><span class="p">)</span><span class="w"> </span><span class="n">outputInst</span><span class="p">);</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">            </span><span class="c1">// 连续获取输出语句</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">instructions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">instructions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">OutputInst</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">constContent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">                    </span><span class="n">buffer</span><span class="p">.</span><span class="na">add</span><span class="p">((</span><span class="n">Instruction</span><span class="p">)</span><span class="w"> </span><span class="n">temp</span><span class="p">);</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">            </span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringBuilder</span><span class="p">();</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">                </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(((</span><span class="n">OutputInst</span><span class="p">)</span><span class="w"> </span><span class="n">output</span><span class="p">).</span><span class="na">getConstContent</span><span class="p">());</span>
<a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sb</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">            </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;\\0A&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">            </span><span class="n">ConstString</span><span class="w"> </span><span class="n">constString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstString</span><span class="p">(</span><span class="n">IRData</span><span class="p">.</span><span class="na">getConstStringName</span><span class="p">(),</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>
<a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="w">            </span><span class="n">PutstrInst</span><span class="w"> </span><span class="n">putstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PutstrInst</span><span class="p">(</span><span class="n">constString</span><span class="p">);</span>
<a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">putstr</span><span class="p">);</span>
<a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">            </span><span class="n">block</span><span class="p">.</span><span class="na">getInstructions</span><span class="p">().</span><span class="na">removeAll</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a><span class="w">            </span><span class="n">changed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="p">}</span>
</code></pre></div>
<h2 id="_15">后端优化</h2>
<h3 id="phi">消除phi结点</h3>
<p>按照教程的算法可以对插入的phi结点进行处理，转化为一组move语句。</p>
<p>检测移动指令之间的依赖关系，避免因覆盖导致的错误，需要引入临时变量以安全地重新排序移动指令，确保原始值在过程中被正确保留。如果前驱块有多个后继块，创建一个新的基本块来保存移动指令，并在新块中添加跳转指令到当前块。这避免了干扰其他后继块的控制流。</p>
<h3 id="_16">寄存器分配</h3>
<p>寄存器分配采用启发式图着色算法。</p>
<ol>
<li>
<p>计算<code>def</code>和<code>use</code>集合，通过$in[B] = use[B] \cup (out[B] - def[B])，  out[B] = \cup_{B的后继块P}in[P]$计算<code>in</code>和<code>out</code>集合</p>
</li>
<li>
<p>构建干涉图，遍历每个基本块，初始化活跃变量集合为该块的OUT集合。</p>
</li>
</ol>
<p>逆序遍历指令，更新活跃变量集合：</p>
<ul>
<li>如果指令定义了一个变量，则从活跃集合中移除该变量，并与当前活跃变量建立干涉关系。</li>
<li>
<p>将指令的操作数添加到活跃变量集合。</p>
</li>
<li>
<p>按照教程的算法实现着色和溢出。</p>
</li>
</ul>
<p>在目标代码生成截断已经为变量在栈上预留了空间，对于溢出的变量，将值存在栈上对应位置即可。</p>
<h3 id="_17">计算强度削弱</h3>
<p>采用教程提到的方法对乘除等计算进行额外处理，从而降低周期数。</p>
<p>对于<code>变量 * 常数</code>类型的乘法运算，可以根据常数的值分类讨论：</p>
<ul>
<li>常数是0、1、-1，比较简单</li>
<li>常数是负数，将其转化为正数，最后使用取反</li>
<li>常数（绝对值）大小在2-9之间，通过已经构造好的方法进行翻译</li>
<li>常数（绝对值）的二进制表示中1的个数不多于2，可以通过移位的组合来实现</li>
<li>除此之外的情况直接使用乘法指令</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">makeVarMulConst</span><span class="p">(</span><span class="n">Register</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">constInt</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="n">targetReg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">LiAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">MoveAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SUBU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isNegative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constInt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">absConstInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">constInt</span><span class="p">);</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">absConstInt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">);</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SUBU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
<a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
<a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">bitCnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">bitCount</span><span class="p">(</span><span class="n">absConstInt</span><span class="p">);</span>
<a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bitCnt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a><span class="w">                </span><span class="c1">// 使用原有的移位和加法逻辑</span>
<a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a><span class="w">                </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">shifts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">;</span>
<a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">absConstInt</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-55" name="__codelineno-29-55" href="#__codelineno-29-55"></a><span class="w">                        </span><span class="n">shifts</span><span class="o">[</span><span class="n">index</span><span class="o">++]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-29-56" name="__codelineno-29-56" href="#__codelineno-29-56"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-29-57" name="__codelineno-29-57" href="#__codelineno-29-57"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-29-58" name="__codelineno-29-58" href="#__codelineno-29-58"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-29-59" name="__codelineno-29-59" href="#__codelineno-29-59"></a>
<a id="__codelineno-29-60" name="__codelineno-29-60" href="#__codelineno-29-60"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bitCnt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-61" name="__codelineno-29-61" href="#__codelineno-29-61"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">shifts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
<a id="__codelineno-29-62" name="__codelineno-29-62" href="#__codelineno-29-62"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-63" name="__codelineno-29-63" href="#__codelineno-29-63"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">shifts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
<a id="__codelineno-29-64" name="__codelineno-29-64" href="#__codelineno-29-64"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SLL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">shifts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">);</span>
<a id="__codelineno-29-65" name="__codelineno-29-65" href="#__codelineno-29-65"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">);</span>
<a id="__codelineno-29-66" name="__codelineno-29-66" href="#__codelineno-29-66"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-29-67" name="__codelineno-29-67" href="#__codelineno-29-67"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-68" name="__codelineno-29-68" href="#__codelineno-29-68"></a><span class="w">                </span><span class="c1">// 对于其他情况，使用乘法</span>
<a id="__codelineno-29-69" name="__codelineno-29-69" href="#__codelineno-29-69"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">LiAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">absConstInt</span><span class="p">);</span>
<a id="__codelineno-29-70" name="__codelineno-29-70" href="#__codelineno-29-70"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MUL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">);</span>
<a id="__codelineno-29-71" name="__codelineno-29-71" href="#__codelineno-29-71"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-29-72" name="__codelineno-29-72" href="#__codelineno-29-72"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-73" name="__codelineno-29-73" href="#__codelineno-29-73"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isNegative</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-74" name="__codelineno-29-74" href="#__codelineno-29-74"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SUBU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">targetReg</span><span class="p">);</span>
<a id="__codelineno-29-75" name="__codelineno-29-75" href="#__codelineno-29-75"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-76" name="__codelineno-29-76" href="#__codelineno-29-76"></a><span class="p">}</span>
</code></pre></div>
<p>对于除法，可以参考论文中的实现：</p>
<p><img alt="图片#100% #auto" src="https://drinkwater-1325041233.cos.ap-guangzhou.myqcloud.com/imgs/cguserImages" /></p>
<p>代码实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OptimizedDivision</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">calculateMagicNumber</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">divisor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">divisor</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">divisor</span><span class="p">;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">divisor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">divisor</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">            </span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">divisor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mi">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">divisor</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">divisor</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">makeVarDivConst</span><span class="p">(</span><span class="n">Register</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">constInt</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="n">targetReg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">abs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">constInt</span><span class="p">);</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SUBU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">MoveAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">abs</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">            </span><span class="c1">// Power of 2 case</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">numberOfLeadingZeros</span><span class="p">(</span><span class="n">abs</span><span class="p">);</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">            </span><span class="n">Register</span><span class="w"> </span><span class="n">dividend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDividend</span><span class="p">(</span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">abs</span><span class="p">);</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRA</span><span class="p">,</span><span class="w"> </span><span class="n">dividend</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">);</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">            </span><span class="c1">// Use pre-calculated magic numbers for small divisors</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateMagicNumber</span><span class="p">(</span><span class="n">abs</span><span class="p">);</span>
<a id="__codelineno-30-30" name="__codelineno-30-30" href="#__codelineno-30-30"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="__codelineno-30-31" name="__codelineno-30-31" href="#__codelineno-30-31"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="__codelineno-30-32" name="__codelineno-30-32" href="#__codelineno-30-32"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">LiAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-30-33" name="__codelineno-30-33" href="#__codelineno-30-33"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">MulDivAsm</span><span class="p">(</span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MULT</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">);</span>
<a id="__codelineno-30-34" name="__codelineno-30-34" href="#__codelineno-30-34"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">MDRegAsm</span><span class="p">(</span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MFHI</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">);</span>
<a id="__codelineno-30-35" name="__codelineno-30-35" href="#__codelineno-30-35"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRA</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">);</span>
<a id="__codelineno-30-36" name="__codelineno-30-36" href="#__codelineno-30-36"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">A0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">);</span>
<a id="__codelineno-30-37" name="__codelineno-30-37" href="#__codelineno-30-37"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">A0</span><span class="p">);</span>
<a id="__codelineno-30-38" name="__codelineno-30-38" href="#__codelineno-30-38"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-39" name="__codelineno-30-39" href="#__codelineno-30-39"></a><span class="w">            </span><span class="c1">// Original logic for larger divisors</span>
<a id="__codelineno-30-40" name="__codelineno-30-40" href="#__codelineno-30-40"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<a id="__codelineno-30-41" name="__codelineno-30-41" href="#__codelineno-30-41"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">abs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-30-42" name="__codelineno-30-42" href="#__codelineno-30-42"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">abs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">abs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-43" name="__codelineno-30-43" href="#__codelineno-30-43"></a><span class="w">                </span><span class="n">t</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-30-44" name="__codelineno-30-44" href="#__codelineno-30-44"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-30-45" name="__codelineno-30-45" href="#__codelineno-30-45"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">abs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">abs</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">abs</span><span class="p">);</span>
<a id="__codelineno-30-46" name="__codelineno-30-46" href="#__codelineno-30-46"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="__codelineno-30-47" name="__codelineno-30-47" href="#__codelineno-30-47"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="__codelineno-30-48" name="__codelineno-30-48" href="#__codelineno-30-48"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">LiAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-30-49" name="__codelineno-30-49" href="#__codelineno-30-49"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x80000000L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-50" name="__codelineno-30-50" href="#__codelineno-30-50"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">MDRegAsm</span><span class="p">(</span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MTHI</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">);</span>
<a id="__codelineno-30-51" name="__codelineno-30-51" href="#__codelineno-30-51"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">MulDivAsm</span><span class="p">(</span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MADD</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">);</span>
<a id="__codelineno-30-52" name="__codelineno-30-52" href="#__codelineno-30-52"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-53" name="__codelineno-30-53" href="#__codelineno-30-53"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">MulDivAsm</span><span class="p">(</span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MULT</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">);</span>
<a id="__codelineno-30-54" name="__codelineno-30-54" href="#__codelineno-30-54"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-30-55" name="__codelineno-30-55" href="#__codelineno-30-55"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">MDRegAsm</span><span class="p">(</span><span class="n">AsmOp</span><span class="p">.</span><span class="na">MFHI</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">);</span>
<a id="__codelineno-30-56" name="__codelineno-30-56" href="#__codelineno-30-56"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRA</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">);</span>
<a id="__codelineno-30-57" name="__codelineno-30-57" href="#__codelineno-30-57"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">A0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRL</span><span class="p">,</span><span class="w"> </span><span class="n">varReg</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">);</span>
<a id="__codelineno-30-58" name="__codelineno-30-58" href="#__codelineno-30-58"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">A0</span><span class="p">);</span>
<a id="__codelineno-30-59" name="__codelineno-30-59" href="#__codelineno-30-59"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-60" name="__codelineno-30-60" href="#__codelineno-30-60"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constInt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-61" name="__codelineno-30-61" href="#__codelineno-30-61"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">targetReg</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SUBU</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">targetReg</span><span class="p">);</span>
<a id="__codelineno-30-62" name="__codelineno-30-62" href="#__codelineno-30-62"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-63" name="__codelineno-30-63" href="#__codelineno-30-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-64" name="__codelineno-30-64" href="#__codelineno-30-64"></a>
<a id="__codelineno-30-65" name="__codelineno-30-65" href="#__codelineno-30-65"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="nf">getDividend</span><span class="p">(</span><span class="n">Register</span><span class="w"> </span><span class="n">oldDividend</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">abs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-66" name="__codelineno-30-66" href="#__codelineno-30-66"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">numberOfLeadingZeros</span><span class="p">(</span><span class="n">abs</span><span class="p">);</span>
<a id="__codelineno-30-67" name="__codelineno-30-67" href="#__codelineno-30-67"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRA</span><span class="p">,</span><span class="w"> </span><span class="n">oldDividend</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">);</span>
<a id="__codelineno-30-68" name="__codelineno-30-68" href="#__codelineno-30-68"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-69" name="__codelineno-30-69" href="#__codelineno-30-69"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">SRL</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l</span><span class="p">);</span>
<a id="__codelineno-30-70" name="__codelineno-30-70" href="#__codelineno-30-70"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-71" name="__codelineno-30-71" href="#__codelineno-30-71"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">CalcAsm</span><span class="p">(</span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">,</span><span class="w"> </span><span class="n">AsmOp</span><span class="p">.</span><span class="na">ADDU</span><span class="p">,</span><span class="w"> </span><span class="n">oldDividend</span><span class="p">,</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V0</span><span class="p">);</span>
<a id="__codelineno-30-72" name="__codelineno-30-72" href="#__codelineno-30-72"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Register</span><span class="p">.</span><span class="na">V1</span><span class="p">;</span>
<a id="__codelineno-30-73" name="__codelineno-30-73" href="#__codelineno-30-73"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-74" name="__codelineno-30-74" href="#__codelineno-30-74"></a><span class="p">}</span>
</code></pre></div>
<h3 id="_18">窥孔优化</h3>
<p>针对一小段mips代码也可进行优化，亦能取得不错的效果。</p>
<p><code>PlatoCompiler</code>设计的窥孔优化种类如下：</p>
<ul>
<li>相邻的jump和label</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>j label1 # 可删去
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>label1:
</code></pre></div>
<ul>
<li>
<p>加法转换：<code>addiu $t1, $t2, 0</code>可变为<code>move $t1, $t2</code></p>
</li>
<li>
<p>删除多余的move</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>move $t1, $t1 # 可删去
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>move $t1, $t2 # 可删去
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>move $t1, $t3 
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>move $t1, $t2
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>move $t2, $t1 # 可删去
</code></pre></div>
<ul>
<li>访存优化</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>sw $t1, 0($t0)
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>lw $t2, 0($t0)
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>move $t2, $t1 # 与以上代码等价
</code></pre></div>
<ul>
<li>条件跳转优化</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>beq $t4, $zero, label1
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>j label2
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>label1:
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a># 可转化为
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>bne $t4, $zero, label2
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>label1:
</code></pre></div>
<ul>
<li>加强无条件跳转优化：经过以上优化之后可能有空块，此时删去无条件跳转指令，pc也能自然移动到目标标签</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>j main_b7 # 可删去
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>main_b4:
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a># move %37 -&gt; %3
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a># br label %7
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>main_b7:
</code></pre></div>
<ul>
<li>立即数优化：可能用于连续输出</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>li $t1, 5 # 可删去
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>li $t1, 10
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>move $t2, $t1
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../index.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: Jew的文档杂项">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Jew的文档杂项
              </div>
            </div>
          </a>
        
        
          
          <a href="%E7%BC%96%E8%AF%91%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93%E6%84%9F%E6%83%B3.html" class="md-footer__link md-footer__link--next" aria-label="下一页: 编译实验总结感想">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                编译实验总结感想
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Zhu Xiongwei
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.instant.preview", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.tabs.sections", "navigation.expand", "navigation.path", "navigation.indexes", "toc.follow", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>